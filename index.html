<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clasificador de Moda - IA con p5.js</title>
    <script src="https://cdn.jsdelivr.net/npm/p5@latest/lib/p5.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ml5@latest/dist/ml5.min.js"></script>
</head>
<body>
    <h1>Clasificador de Moda con IA</h1>
    <p>Usa la cámara o sube una imagen para detectar prendas de moda.</p>

    <input type="file" accept="image/*" onchange="handleImageUpload(event)">
    <br><br>
    <div id="canvas-container"></div>
    <p id="result-label">Cargando modelo...</p>

    <script>
        let classifier;
        let imageModelURL = "https://teachablemachine.withgoogle.com/models/PWJnkriky/";

        let video;
        let label = "Esperando...";
        let img = null; // Imagen cargada
        let modelLoaded = false; // Para verificar que el modelo está listo

        function preload() {
            console.log("Cargando modelo...");
            classifier = ml5.imageClassifier(imageModelURL + "model.json", function() {
                console.log("Modelo cargado.");
                modelLoaded = true;
                document.getElementById("result-label").innerText = "Modelo listo. Usa la cámara o sube una imagen.";
                classifyVideo();
            });
        }

        function setup() {
            let canvas = createCanvas(320, 260);
            canvas.parent("canvas-container");

            video = createCapture(VIDEO);
            video.size(320, 240);
            video.hide();
        }

        function draw() {
            background(0);
            if (img) {
                image(img, 0, 0, width, height);
            } else {
                image(video, 0, 0);
            }
            
            fill(255);
            textSize(16);
            textAlign(CENTER);
            text(label, width / 2, height - 10);
        }

        function classifyVideo() {
            if (!modelLoaded) return; // Esperar a que el modelo cargue
            classifier.classify(video, gotResult);
        }

        function gotResult(error, results) {
            if (error) {
                console.error("Error en la predicción:", error);
                return;
            }
            label = results[0].label;
            document.getElementById("result-label").innerText = "Resultado: " + label;
            classifyVideo(); // Volver a predecir en el video
        }

        function handleImageUpload(event) {
            if (!modelLoaded) {
                alert("Espera a que el modelo termine de cargar.");
                return;
            }

            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    img = loadImage(e.target.result, function () {
                        classifier.classify(img, function (error, results) {
                            if (error) {
                                console.error("Error en la predicción de la imagen:", error);
                                return;
                            }
                            label = results[0].label;
                            document.getElementById("result-label").innerText = "Resultado: " + label;
                        });
                    });
                };
                reader.readAsDataURL(file);
            }
        }
    </script>
</body>
</html>
